{% extends "admin/base_site.html" %}
{% load static %}

{% block extrahead %}
  {{ block.super }}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="container-fluid">

  <h1 class="mb-4">Sales Dashboard</h1>

  <!-- Stats cards -->
  <div class="row">
    <div class="col-md-4">
      <div class="card bg-success text-white mb-3">
        <div class="card-body">
          <h5>Total Sales</h5>
          <h2>${{ total_sales }}</h2>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card bg-primary text-white mb-3">
        <div class="card-body">
          <h5>Total Orders</h5>
          <h2>{{ total_orders }}</h2>
        </div>
      </div>
    </div>

    <div class="col-md-4">
      <div class="card bg-info text-white mb-3">
        <div class="card-body">
          <h5>Total Products</h5>
          <h2>{{ total_products }}</h2>
        </div>
      </div>
    </div>
  </div>

  <!-- Top products -->
  <h3 class="mt-4">Top Selling Products</h3>
  <table class="table table-striped">
    <thead>
      <tr>
        <th>Product</th>
        <th>Quantity Sold</th>
      </tr>
    </thead>
    <tbody>
      {% for item in top_products %}
      <tr>
        <td>{{ item.product__productName }}</td>
        <td>{{ item.total_qty }}</td>
      </tr>
      {% empty %}
      <tr>
        <td colspan="2">No sales yet.</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- Sales by category chart -->
  <h3 class="mt-5">Sales by Category</h3>
  <canvas id="categoryChart"></canvas>

  <script>
    const categoryData = {{ category_sales_json|safe }};
    const categoryLabels = categoryData.map(item => item.product__categoryID__categoryName || "Unknown");
    const categoryTotals = categoryData.map(item => item.total);

    new Chart(
      document.getElementById("categoryChart"),
      {
        type: "bar",
        data: {
          labels: categoryLabels,
          datasets: [{
            label: "Sales ($)",
            data: categoryTotals,
            backgroundColor: "rgba(54, 162, 235, 0.6)"
          }]
        },
        options: {
          scales: {
            y: {
              beginAtZero: true
            }
          }
        }
      }
    );
  </script>

</div>
{% endblock %}
