{% load static %}
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Your Cart | LuxÃ© Beauty</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Poppins:wght@300;400;500&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
    />
    <link rel="stylesheet" href="{% static 'css/custom.css' %}" />

    <style>
      .quantity-selector {
        display: flex;
        align-items: center;
        background: white;
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        overflow: hidden;
        width: fit-content;
      }
      .quantity-btn {
        width: 44px;
        height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 20px;
        color: #2c3e50;
        transition: all 0.2s ease;
        user-select: none;
      }
      .quantity-btn:hover {
        background: #f0f0f0;
      }
      .quantity-input {
        width: 60px;
        height: 44px;
        border: none;
        text-align: center;
        font-size: 16px;
        font-weight: 500;
        color: #2c3e50;
      }
      .quantity-input:focus {
        outline: none;
      }
      .cart-item {
        transition: all 0.3s ease;
        border-radius: 12px;
      }
      .cart-item:hover {
        background: #f9f9f9;
      }
      .item-total {
        font-weight: 600;
        color: #2c3e50;
        font-size: 1.2rem;
      }
      .summary-total {
        font-size: 1.6rem;
        font-weight: 700;
        color: #2c3e50;
      }
      .qr-code {
        max-width: 200px;
        margin: 20px auto;
        padding: 15px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }
      .upload-area {
        border: 2px dashed #ccc;
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        background: #fafafa;
        cursor: pointer;
        transition: all 0.3s;
      }
      .upload-area:hover {
        border-color: #2c3e50;
        background: #f0f0f0;
      }
    </style>
  </head>
  <body class="bg-light">
    {% include 'navbar.html' %}

    <div class="container my-5">
      <h1
        class="text-center mb-5"
        style="
          font-family: 'Playfair Display', serif;
          color: #2c3e50;
          font-size: 3rem;
        "
      >
        Your Cart
      </h1>

      {% if cart|length == 0 %}
      <div class="text-center py-5">
        <i class="fas fa-shopping-bag fa-5x text-muted mb-4"></i>
        <p class="fs-3 text-muted">Your cart is empty</p>
        <a href="{% url 'home' %}" class="btn btn-dark rounded-pill px-5 py-3"
          >Start Shopping</a
        >
      </div>
      {% else %}
      <div class="row g-5">
        <div class="col-lg-8">
    {% for item in cart %}
        {% with product=item.product price=item.price|floatformat:2 %}
        <div class="card mb-3 border-0 shadow-sm cart-item" 
             data-product-id="{{ product.id }}" 
             data-price="{{ price }}">
            <div class="row g-0 align-items-center p-4">
                <div class="col-3 col-md-2">
                    <img src="{{ product.productImage.url }}" 
                         class="img-fluid rounded" style="height: 120px; object-fit: contain;">
                </div>
                <div class="col-5 col-md-6">
                    <h5 class="mb-1">{{ product.productName }}</h5>
                    <p class="text-muted small mb-0">${{ price }} each</p>
                </div>

                <div class="col-4 col-md-2">
                    <div class="quantity-selector mx-auto">
                        <div class="quantity-btn" onclick="updateQty({{ product.id }}, -1)">âˆ’</div>
                        <input type="number" 
                               value="{{ item.quantity }}" 
                               class="quantity-input"
                               data-id="{{ product.id }}"
                               readonly>
                        <div class="quantity-btn" onclick="updateQty({{ product.id }}, 1)">+</div>
                    </div>
                </div>

                <div class="col-12 col-md-2 text-end mt-3 mt-md-0">
                    <div class="item-total mb-2" id="total-{{ product.id }}">
                        ${{ item.total_price }}
                    </div>
                    <form action="{% url 'cart_remove' product.id %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger">Remove</button>
                    </form>
                </div>
            </div>
        </div>
        {% endwith %}
    {% endfor %}  <!-- â† Now on its own line, after endwith -->
</div>

        <!-- Order Summary + QR Code + Upload -->
        <div class="col-lg-4">
          <div class="card border-0 shadow p-4 sticky-top" style="top: 100px">
            <h4 class="mb-4" style="font-family: 'Playfair Display', serif">
              Order Summary
            </h4>

            <div class="d-flex justify-content-between mb-2">
              <span>Subtotal</span>
              <span id="subtotal">${{ cart.get_total_price }}</span>
            </div>
            <div class="d-flex justify-content-between mb-3 text-muted">
              <span>Delivery</span>
              <span>$2.00</span>
            </div>
            <hr />
            <div class="d-flex justify-content-between mb-4">
              <strong class="summary-total">Total</strong>
              <strong class="summary-total text-primary" id="grand-total">
                ${{ cart.get_total_price|floatformat:2|add:2 }}
              </strong>
            </div>

            <!-- QR Code for Payment -->
            <!-- QR Code for Payment -->
<div class="text-center">
  <p class="mb-2 text-muted">Scan to Pay</p>
  <p class="small mb-3">
    or <a id="payLink" href="#" target="_blank" rel="noopener" class="text-decoration-underline link-primary">click here to get exact amount of qr</a>
  </p>
  <div class="qr-code">
    <img src="{% static 'qrcode.jpg' %}" alt="Payment QR Code" class="img-fluid">
  </div>
  <p class="small text-muted mt-3">After payment, upload screenshot below</p>
</div>

            <!-- â–¼  UPLOAD AREA + LIVE PREVIEW  â–¼ -->
<div class="text-center">
  <div id="uploadBox" class="upload-area mt-4"
       onclick="document.getElementById('payment-upload').click()">
    <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-3"></i>
    <p class="mb-0 text-muted">Click to upload payment screenshot</p>
    <input type="file"
           id="payment-upload"
           accept="image/*"
           style="display:none"
           onchange="handlePaymentUpload()">
  </div>

  <!-- receipt placeholder -->
  <div id="receiptPreview" class="mt-3 d-none">
    <img id="receiptImg" class="img-fluid rounded-3 shadow-sm"
         style="max-height:260px; object-fit:contain;">
    <p class="small text-muted mt-2 mb-0">Receipt uploaded â€“ thank you!</p>
  </div>
</div>
<!-- â–²  END UPLOAD AREA  â–² -->

            {% if user.is_authenticated %}
            <a
              href="{% url 'checkout' %}"
              class="btn btn-dark w-100 rounded-pill py-3 mt-4"
              >Proceed to Checkout</a
            >
            {% else %}
            <a
              href="{% url 'login' %}?next={% url 'checkout' %}"
              class="btn btn-dark w-100 rounded-pill py-3 mt-4"
            >
              Proceed to Checkout
            </a>
            <p class="text-center small text-muted mt-2">Login to continue</p>
            {% endif %}
          </div>
        </div>
      </div>
      {% endif %}
    </div>

    {% include 'footer.html' %}

    <!-- Payment Success Modal -->
    <!-- Payment Success Modal -->
<div class="modal fade" id="paymentSuccessModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-body text-center py-5">
        <div class="success-check d-inline-block mb-4">
          <i class="fas fa-check"></i>
        </div>
        <h3 class="mb-3">Payment Successfully Received!</h3>
        <p class="text-muted">
          Thank you for your payment. Your order is being processed.
        </p>
        <!-- NEW: simple OK button that only closes the modal -->
        <button type="button" class="btn btn-dark rounded-pill px-5 py-3"
                data-bs-dismiss="modal">OK</button>
      </div>
    </div>
  </div>
</div>

    <!-- LIVE QUANTITY UPDATE + Payment Upload Script -->
    <script>
      function updateQty(productId, change) {
  const item = document.querySelector(
    `.cart-item[data-product-id="${productId}"]`
  );

  const input = item.querySelector(".quantity-input");
  let qty = parseInt(input.value) + change;

  if (qty < 1) qty = 1;
  input.value = qty;

  fetch(`/cart/update/${productId}/`, {
    method: "POST",
    headers: {
      "X-CSRFToken": document.querySelector("[name=csrfmiddlewaretoken]").value,
      "Content-Type": "application/x-www-form-urlencoded",
    },
    body: `quantity=${qty}`,
  })
    .then((res) => res.json())
    .then((data) => {
      // Update item total
      document.getElementById(
        `total-${productId}`
      ).textContent = `$${data.item_total.toFixed(2)}`;

      // Update cart totals
      document.getElementById(
        "subtotal"
      ).textContent = `$${data.subtotal.toFixed(2)}`;

      document.getElementById(
        "grand-total"
      ).textContent = `$${data.grand_total.toFixed(2)}`;

      // ðŸ”¥ Sync QR payment link with new total
      refreshPayLink();
    })
    .catch((err) => console.error("Cart update failed:", err));
}

      /* ========== elegant receipt preview ========== */
function handlePaymentUpload() {
  const fileInput = document.getElementById('payment-upload');
  const previewWrap = document.getElementById('receiptPreview');
  const previewImg  = document.getElementById('receiptImg');
  const uploadBox   = document.getElementById('uploadBox');

  if (fileInput.files && fileInput.files[0]) {
    const reader = new FileReader();
    reader.onload = e => {
      previewImg.src = e.target.result;
      uploadBox.classList.add('d-none');        // â† hide upload prompt
      previewWrap.classList.remove('d-none');   // â† show receipt
      const modal = new bootstrap.Modal(document.getElementById('paymentSuccessModal'));
      modal.show();
    };
    reader.readAsDataURL(fileInput.files[0]);
  }
}

      // Initial total calculation
      document.addEventListener("DOMContentLoaded", () => {
        let subtotal = 0;
        document.querySelectorAll(".cart-item").forEach((i) => {
          const p = parseFloat(i.dataset.price);
          const q = parseInt(i.querySelector(".quantity-input").value);
          subtotal += p * q;
        });
        document.getElementById("subtotal").textContent = `$${subtotal.toFixed(
          2
        )}`;
        document.getElementById("grand-total").textContent = `$${(
          subtotal + 2
        ).toFixed(2)}`;
      });

      /* ---------- build / refresh dynamic paylink ---------- */
function buildPayLink(total){
  const base = 'https://link.payway.com.kh/aba?id=95E6A1F3659F&dynamic=true&source_caller=sdk&pid=af_app_invites&link_action=abaqr&shortlink=vxjx0dgw&created_from_app=true&acc=005000889&af_siteid=968860649&userid=95E6A1F3659F&code=972223&c=abaqr&af_referrer_uid=1669164760843-4602397';
  return base + '&amount=' + total.toFixed(2);
}
function refreshPayLink(){
  const grand = parseFloat(document.getElementById('grand-total').textContent.replace('$',''));
  document.getElementById('payLink').href = buildPayLink(grand);
}
document.addEventListener('DOMContentLoaded', refreshPayLink);
/* also call it inside fetch().then() in updateQty() after you update the totals: */
/* .then(data=>{ ...... refreshPayLink(); }) */



    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
